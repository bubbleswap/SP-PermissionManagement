<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8" />
    <title>User Permissions</title>
    <!-- Third Party Style Sheets -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/select2.css" />
    <link rel="stylesheet" href="css/bootstrap-duallistbox.css" />
    <!-- Our Style Sheets -->
    <!-- Third Party JavaScript -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/select2.min.js"></script>
    <script src="js/jquery.bootstrap-duallistbox.js"></script>
    <!-- Our JavaScript -->
    <style>
        .select2-container {
            width: 200px;
        }

        .column {
            float: left;
            width: 33%;
        }
        .permissions {
            display: none;
        }
        .box1, .box2 {
            /*width: 40%;
            float: left;*/
        } 
        .moveall {
            content: string('Give All');
        }
        .removeall {
            content: string('Remove All');
        }
        .userInfo tr td:first-child {
           text-align:right;
        }
    </style>
</head>
<body>
    <div>
        <h1>User Permissions </h1>
        Select a user: <div id="users"></div>
        <div class="userInfo">
            <table>
                <tr>
                    <td>Display Name: </td>
                    <td><input class="name" type="text" /></td>
                </tr>
                <tr>
                    <td>Username: </td>
                    <td><input class="login" type="text" /></td>
                </tr>
                <tr>
                    <td>Email: </td>
                    <td><input class="email" type="text" /></td>
                </tr>
            </table>
            <button type="button" class="getPermissionBtn btn btn-primary">
                Get Permissions
            </button>
            <button id="submit" type="button" class="savePermissionBtn btn btn-primary">
                Save Permissions
            </button>
            <div class="notify"></div>
        </div>
        <select class="permissions" multiple="multiple"></select>
    </div>

    <script>
        var userArr = [], userPermissions = {}, newPermissions = {}, permSelect,
            notification_map = {
                wait: 'Please wait...',
                save: 'Saving...',
                error: 'Error!',
                complete: 'Complete!'
            }, url = '',
            state_map = {
                pendingSaves: 0,
                pendingRemoves: 0,
                failed: {
                    add: [],
                    remove: []
                }
            };

        $(document).ready(function () {
            $('.notify').text(notification_map.wait);
            getUsers(url, function (results) {
                // addUser(results, results.length, 0, console.log('done!'));
                $("#users").select2({
                    id: function (e) { return e.name + '|' + e.login + '|' + e.email },
                    data: {
                        results: results,
                        text: function (item) {
                            return item.name;
                        },
                        name: function (item) {
                            return item.name;
                        },
                        login: function (item) {
                            return item.login;
                        },
                        email: function (item) {
                            return item.email;
                        }
                    },
                    formatSelection: format,
                    formatResult: format
                });
            });
            getPermissions(url, false, function (results) {
                addPermission($('.permissions'), results, results.length, 0, function () {
                    permSelect = $('.permissions').bootstrapDualListbox({
                        nonSelectedListLabel: 'Available Permissions',
                        selectedListLabel: 'User Permissions',
                        preserveSelectionOnMove: 'moved',
                        moveOnSelect: false,
                        nonSelectedFilter: '',
                        selectorMinimalHeight: 300,
                        callback: function () {
                            $('.notify').text(notification_map.complete);
                            $('.moveall').html('Give All &rarr;&rarr;');
                            $('.removeall').html('&larr;&larr; Remove All');
                            $('.move').html('Give Selected &rarr;');
                            $('.remove').html('&larr; Remove Selected');
                            $('.filter').css({
                                'background': 'url("images/search.png") no-repeat right',
                                'background-size': '28px 28px'
                            });
                        }
                    });
                });
            });
        });

        function format(item) { return item.name; }
        // Begin Utility Method /printError/
        printError = function (XMLHttpRequest, textStatus, errorThrown) {
            $('.notify').text(notification_map.error + '\n' + "There was an error: " + errorThrown + " " + textStatus + '\n' + XMLHttpRequest.responseText);
            console.log("There was an error: " + errorThrown + " " + textStatus);
            console.log(XMLHttpRequest.responseText);
        };
        // End Utility Method /printError/
        addUser = function (arr, max, index, callback) {
            var name, email, login;

            name = arr[index].name;
            email = arr[index].email;
            login = arr[index].login;

            $('<li> ' + name + '</li>').appendTo($('.users'));

            index++;
            if (index < max) {
                setTimeout(function () {
                    addUser(arr, max, index, callback);
                }, 10);

            } else if (callback) {
                callback();
            }
        };
        addPermission = function ($target, arr, max, index, callback) {
            var name, email;

            name = arr[index].name;
            description = arr[index].description;
          
            $('<Option value=' + name.replace(/\s/g, '_') + '>' + name + '</Option>').appendTo($target);

            index++;
            if (index < max) {
                setTimeout(function () {
                    addPermission($target, arr, max, index, callback);
                }, 10);

            } else if (callback) {
                callback();
            }
        };
        //returns an object of all permissions and
        //their values equal to whether or not the user has
        //the permission
        getPermissions = function (url, username, callback) {
            var results = [], soapEnv, body, soapAction;

            if (username) {
                body = '<GetGroupCollectionFromUser xmlns="http://schemas.microsoft.com/sharepoint/soap/directory/">\
                        <userLoginName>'+ username + '</userLoginName>\
                      </GetGroupCollectionFromUser>';
                soapAction = "http://schemas.microsoft.com/sharepoint/soap/directory/GetGroupCollectionFromUser";
            } else {
                body = ' <GetGroupCollectionFromSite xmlns="http://schemas.microsoft.com/sharepoint/soap/directory/" />';
                soapAction = "http://schemas.microsoft.com/sharepoint/soap/directory/GetGroupCollectionFromSite";
            }

            soapEnv =
              '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">\
                     <soap:Body>\
                    '+ body + '\
                    </soap:Body>\
                </soap:Envelope>';



            $.ajax({
                url: url + "/_vti_bin/UserGroup.asmx",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('SOAPAction', soapAction);
                },
                type: "POST",
                dataType: "xml",
                data: soapEnv,
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    printError(XMLHttpRequest, textStatus, errorThrown)
                    this.tryCount++;
                    if (this.tryCount <= this.retryLimit) {
                        //try again
                        $.ajax(this);
                        return;
                    } else if (callback) {
                        callback(textStatus);
                    }
                },
                complete: function (xData, status) {
                    $(xData.responseText).find("group").each(function () {
                        var $this = $(this)[0],
                        name, description;

                        name = $this.getAttribute('name');
                        description = $this.getAttribute('description');
                        results.push({ name: name, description: description });
                    });

                    if (callback) {
                        callback(results);
                    }
                },
                contentType: "text/xml; charset=\"utf-8\""
            });
        };
        // End Utility Method /getWebs/

        // Begin Utility Method /getUsers/
        //returns a list of users from a site
        getUsers = function (url, callback) {
            var results = [],

            // Create the SOAP request
             soapEnv =
                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">\
                <soap:Body>\
                  <GetUserCollectionFromSite xmlns="http://schemas.microsoft.com/sharepoint/soap/" />\
                </soap:Body>\
            </soap:Envelope>';


            $.ajax({
                url: url + "/_vti_bin/UserGroup.asmx",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('SOAPAction', "http://schemas.microsoft.com/sharepoint/soap/directory/GetUserCollectionFromSite");
                },
                type: "POST",
                dataType: "xml",
                data: soapEnv,
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    printError(XMLHttpRequest, textStatus, errorThrown)
                    this.tryCount++;
                    if (this.tryCount <= this.retryLimit) {
                        //try again
                        $.ajax(this);
                        return;
                    } else if (callback) {
                        callback(textStatus);
                    }
                },
                complete: function (xData, status) {
                    $(xData.responseText).find("user").each(function () {
                        var $this = $(this)[0],
                        name, email, login;

                        name = $this.getAttribute('name');
                        email = $this.getAttribute('email');
                        login = $this.getAttribute('loginname');

                        results.push({ name: name, email: email, login: login });
                    });

                    if (callback) {
                        callback(results);
                    }
                },
                contentType: "text/xml; charset=\"utf-8\""
            });
        };
        // End Utility Method /getUsers/

        //adds a user to a group
        addUserToGroup = function (url, groupName, user, callback) {
            var results = [],
                groupName = groupName,
                name = user.name,
                login = user.login,
                email = user.email,
                description = user.description || '',
                // Create the SOAP request
                 soapEnv =
                    '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">\
                    <soap:Body>\
                        <AddUserToGroup xmlns="http://schemas.microsoft.com/sharepoint/soap/directory/">\
                            <groupName>'+groupName+'</groupName>\
                            <userName>'+name+'</userName>\
                            <userLoginName>'+login+'</userLoginName>\
                            <userEmail>'+email+'</userEmail>\
                            <userNotes>' + description + '</userNotes>\
                        </AddUserToGroup>\
                    </soap:Body>\
                </soap:Envelope>';


            $.ajax({
                url: url + "/_vti_bin/UserGroup.asmx",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('SOAPAction', "http://schemas.microsoft.com/sharepoint/soap/directory/AddUserToGroup");
                },
                type: "POST",
                dataType: "xml",
                data: soapEnv,
                tryCount: 0,
                retryLimit: 0,
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    printError(XMLHttpRequest, textStatus, errorThrown)
                    this.tryCount++;
                    if (this.tryCount <= this.retryLimit) {
                        //try again
                        $.ajax(this);
                        return;
                    } else if (callback) {
                        callback(textStatus);
                    }
                },
                complete: function (xData, status) {
                    if (callback) {
                        callback({ groupName: groupName, status: status });
                    }
                },
                contentType: "text/xml; charset=\"utf-8\""
            });
        };
        // End Utility Method /addUserToGroup/

        // Begin utility method /removeUserFromGroup/
        removeUserFromGroup = function (url, groupName, user, callback) {
            var results = [],
                groupName = groupName,
                login = user.login,
                // Create the SOAP request
                 soapEnv =
                    '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">\
                    <soap:Body>\
                        <RemoveUserFromGroup xmlns="http://schemas.microsoft.com/sharepoint/soap/directory/">\
                            <groupName>'+ groupName + '</groupName>\
                            <userLoginName>'+ login + '</userLoginName>\
                        </RemoveUserFromGroup>\
                    </soap:Body>\
                </soap:Envelope>';


            $.ajax({
                url: url + "/_vti_bin/UserGroup.asmx",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('SOAPAction', "http://schemas.microsoft.com/sharepoint/soap/directory/RemoveUserFromGroup");
                },
                type: "POST",
                dataType: "xml",
                data: soapEnv,
                tryCount: 0,
                retryLimit: 0,
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    printError(XMLHttpRequest, textStatus, errorThrown)
                    this.tryCount++;
                    if (this.tryCount <= this.retryLimit) {
                        //try again
                        $.ajax(this);
                        return;
                    } else if (callback) {
                        callback({ status: textStatus });
                    }
                },
                complete: function (xData, status) {
                    if (callback) {
                        callback({ groupName: groupName, status: status });
                    }
                },
                contentType: "text/xml; charset=\"utf-8\""
            });
        };
        // End Utility Method /removeUserFromGroup/

        // Begin Utility Method /modifyPermissions/
        modifyPermissions = function (permissionArr, index, user, url, operation, callback) {
            var permission;
            if (!(permissionArr instanceof Array)) {
                return false;
            }
            if (index < permissionArr.length) {
                permission =  permissionArr[index].replace(/_/g, ' ');
                switch (operation) {
                    case 'add':
                        addUserToGroup(url, permission, user, function (results) {
                            onModifyPermissionComplete({ operation: operation, status: results.status, permission: permission});
                        });
                        break;
                    case 'remove':
                        removeUserFromGroup(url, permission, user, function (results) {
                            onModifyPermissionComplete({ operation: operation, status: results.status, permission: permission });
                        });
                        break;
                    default:
                        break;
                }
                index++;
                modifyPermissions(permissionArr, index, user, url, operation, callback);
            } else if (callback) {
                callback();
            }

        }
        // End Utility method /modifyPermissions/

        // Begin DOM method /onModifyPermissionComplete/
        onModifyPermissionComplete = function (result_map) {
            var operation = result_map.operation,
                status = result_map.status,
                permission = result_map.permission,
                notifyText = "";

            state_map.pendingRemoves -= (operation == 'remove' ? 1: 0);
            state_map.pendingSaves -= (operation == 'add' ? 1 :0);

            if (status == 'error') {
                state_map.failed[operation].push(permission);
      
            } else {
                $('.notify').text((operation == 'add' ? 'Saved ' : 'Removed ') + permission);
            }

            if (!state_map.pendingSaves && !state_map.pendingRemoves) {
                notifyText += (state_map.failed.add.length > 0 ? 'Failed Saves: ' + state_map.failed.add.toString() + '\n' : '');
                notifyText += (state_map.failed.remove.length > 0 ? 'Failed Removes: ' + state_map.failed.remove.toString() + '\n' : '');
                notifyText += notification_map.complete;

                $('.notify').html(notifyText);
                userPermissions = {};
                userPermissions = newPermissions;
                newPermissions = {};
            }
        };
        // End DOM method /onModifyPermissionComplete/

        $('#users').on('change', function (e) {
            var $this = $(this),
                name = $this.select2('data').name,
                email = $this.select2('data').email,
                login = $this.select2('data').login;

            $('.name').val(name);
            $('.email').val(email);
            $('.login').val(login);
        });

        $('.getPermissionBtn').on('click', function (e) {
            getPermissions(url, $('.login').val(), function (results) {
                var newPerms = [];
                    // addPermission($('.user-permissions'), results, results.length, 0, console.log('done!'));
                    for (var i = 0; i < results.length; i++) {
                        var name = results[i].name;
                        name = name.replace(/\s/g, '_');
                        newPerms.push(name);
                        userPermissions[name] = true;
                    }
                    $('.permissions').val(newPerms);
                    $('.permissions').bootstrapDualListbox('refresh');
                });
        });

        $("#submit").on('click', function () {
            var permissions = $('.permissions').val() || [],
                addPermissions = [],
                removePermissions = [],
                i, oldPermission,
                user = {
                    name: $('.name').val(),
                    email: $('.email').val(),
                    login: $('.login').val(),
                    description: $('.description').val()
                };

            //get permissions that the user wishes to remove
            //remove permissions
            i = 0;

            //determine permissions that the user is saving
            for (i = 0; i < permissions.length; i++) {
                newPermissions[permissions[i]] = true;
                if (!userPermissions.hasOwnProperty(permissions[i])){
                    addPermissions.push(permissions[i]);
                }
            }

            //determine permissions that the user is removing
            for (oldPermission in userPermissions) {
                i++;
                if (!newPermissions.hasOwnProperty(oldPermission)) {
                    removePermissions.push(oldPermission);
                }
            }

           

            state_map.pendingSaves = addPermissions.length;
            state_map.pendingRemoves = removePermissions.length;

            if (addPermissions.length > 0 || removePermissions.length > 0) {
                $('.notify').text(notification_map.save);
            }
            //add permissions first
            modifyPermissions(addPermissions, 0, user, url, 'add', function () {
                //once we complete adding permissions, go ahead and remove permissions
                modifyPermissions(removePermissions, 0, user, url, 'remove');
            });
          
        });
    </script>
</body>
</html>